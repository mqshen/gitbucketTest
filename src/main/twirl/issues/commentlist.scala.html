@(issue: Option[model.Issue],
  comments: List[model.Comment],
  hasWritePermission: Boolean,
  repository: service.RepositoryService.RepositoryInfo,
  pullreq: Option[model.PullRequest] = None)(implicit context: app.Context)
@import context._
@import view.helpers._

@issue.map { issue =>

<div class="js-discussion js-socket-channel" data-channel="daltoniam/starscream:marked-as-read:44042728">
    <div class="timeline-comment-wrapper js-comment-container">
        <a href="@path/@issue.openedUserName">
            @avatar(issue.openedUserName, 48, avatarClass = "timeline-comment-avatar")
        </a>
        <div id="issue-@issue.issueId" class="comment timeline-comment js-comment js-task-list-container " data-body-version="">
            <div class="timeline-comment-header ">
                <div class="timeline-comment-header-text">

                    <strong>
                        <a href="@path/@issue.openedUserName" class="author">@issue.openedUserName</a>
                    </strong>
                    commented
                    <a href="#issue-@issue.issueId" class="timestamp">
                        @datetime(issue.registeredDate)
                    </a>
                </div>
            </div>
            <div class="comment-content">

                <div class="edit-comment-hide">
                    <div class="comment-body markdown-body markdown-format js-comment-body">
                    @markdown(issue.content getOrElse "No description provided.", repository, false, true)
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


@comments.map {

case comment: model.IssueComment => {
  @if(comment.action != "close" && comment.action != "reopen" && comment.action != "delete_branch"){

      <div class="timeline-comment-wrapper js-comment-container">
          <a href="@path/@comment.commentedUserName">
          @avatar(comment.commentedUserName, 48, avatarClass = "timeline-comment-avatar")
          </a>
          <div id="comment-@comment.commentId" class="comment timeline-comment js-comment js-task-list-container " data-body-version="">
              <div class="timeline-comment-header ">
                  <div class="timeline-comment-header-text">

                      <strong>
                        @user(comment.commentedUserName, styleClass="username strong")
                      </strong>
                      commented
                      <a href="#issue-@issue.issueId" class="timestamp">
                      @datetime(comment.registeredDate)
                      </a>
                  </div>
              </div>
              <div class="comment-content">

                  <div class="edit-comment-hide">
                      <div class="comment-body markdown-body markdown-format js-comment-body">
                      @if(comment.action == "commit" && comment.content.split(" ").last.matches("[a-f0-9]{40}")){
                          @defining(comment.content.substring(comment.content.length - 40)){ id =>
                              <div class="pull-right"><a href="@path/@repository.owner/@repository.name/commit/@id" class="monospace">@id.substring(0, 7)</a></div>
                          @markdown(comment.content.substring(0, comment.content.length - 41), repository, false, true)
                          }
                      } else {
                          @if(comment.action == "refer"){
                              @defining(comment.content.split(":")){ case Array(issueId, rest @ _*) =>
                              <strong><a href="@path/@repository.owner/@repository.name/issues/@issueId">Issue #@issueId</a>: @rest.mkString(":")</strong>
                              }
                          } else {
                              @markdown(comment.content, repository, false, true)
                          }
                      }
                      </div>
                  </div>
              </div>
          </div>
      </div>
  }
  @if(comment.action == "merge"){
    <div class="small" style="margin-top: 10px; margin-bottom: 10px;">
      <span class="label label-info">Merged</span>
      @avatar(comment.commentedUserName, 20)
      @user(comment.commentedUserName, styleClass="username strong") merged commit <code>@pullreq.map(_.commitIdTo.substring(0, 7))</code> into
      @if(pullreq.get.requestUserName == repository.owner){
        <span class="label label-info monospace">@pullreq.map(_.branch)</span> from <span class="label label-info monospace">@pullreq.map(_.requestBranch)</span>
      } else {
        <span class="label label-info monospace">@pullreq.map(_.userName):@pullreq.map(_.branch)</span> to <span class="label label-info monospace">@pullreq.map(_.requestUserName):@pullreq.map(_.requestBranch)</span>
      }
      @datetime(comment.registeredDate)
    </div>
  }
  @if(comment.action == "close" || comment.action == "close_comment"){

      <div class="discussion-item discussion-item-closed">
          <div class="discussion-item-header" id="event-@comment.commentId">
              <span class="octicon octicon-circle-slash discussion-item-icon"></span>
              @avatar(comment.commentedUserName, 20)
              @user(comment.commentedUserName, styleClass="username strong") closed this   @datetime(comment.registeredDate)
          </div>
      </div>

  }
  @if(comment.action == "reopen" || comment.action == "reopen_comment"){

      <div class="discussion-item discussion-item-reopened">
          <div class="discussion-item-header" id="event-@comment.commentId">
              <span class="octicon octicon-primitive-dot discussion-item-icon"></span>
              @avatar(comment.commentedUserName, 20)
              @user(comment.commentedUserName, styleClass="username strong")
          reopened this @datetime(comment.registeredDate)
          </div>
      </div>

  }
  @if(comment.action == "delete_branch"){
    <div class="small issue-comment-action">
      <span class="label">Deleted</span>
      @avatar(comment.commentedUserName, 20)
      @user(comment.commentedUserName, styleClass="username strong") deleted the <span class="label label-info monospace">@pullreq.map(_.requestBranch)</span> branch @datetime(comment.registeredDate)
    </div>
  }
}
}
<script>
$(function(){
  $('i.icon-pencil').click(function(){
    var id  = $(this).closest('a').data('comment-id');
    var url = '@url(repository)/issue_comments/_data/' + id;
    var $content = $('#commentContent-' + id);

    if(!id){
      id  = $(this).closest('a').data('issue-id');
      url = '@url(repository)/issues/_data/' + id;
      $content = $('#issueContent');
    }

    $.get(url,
    {
      dataType : 'html'
    },
    function(data){
      $content.empty().html(data);
    });
    return false;
  });
  $('.issue-comment-box i.icon-remove-circle').click(function(){
    if(confirm('Are you sure you want to delete this?')) {
      var id = $(this).closest('a').data('comment-id');
      $.post('@url(repository)/issue_comments/delete/' + id,
      function(data){
        if(data > 0) {
          $('#comment-' + id).prev('div.issue-avatar-image').remove();
          $('#comment-' + id).remove();
        }
      });
    }
    return false;
  });
});
</script>
}